<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Asistencia - Boda de Marianela y Daniel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíç</text></svg>">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <button id="language-toggle" class="language-toggle" aria-label="Switch to English">EN</button>
        <div class="header-content">
            <h1>Marianela <span class="ampersand">&</span> Daniel</h1>
            <p class="date" data-translate="header_date">11 de abril, 2026</p>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="index.html" data-translate="nav_home">Inicio</a></li>
            <li><a href="details.html" data-translate="nav_details">Detalles</a></li>
            <li><a href="rsvp.html" class="active" data-translate="nav_rsvp">Confirmar Asistencia</a></li>
        </ul>
    </nav>
    
    <main>
        <section class="welcome">
            <h2 data-translate="rsvp_title">Confirma tu Asistencia a Nuestra Boda</h2>
            <p data-translate="rsvp_description">Por favor d√©janos saber si podr√°s acompa√±arnos en nuestro d√≠a especial. Te pedimos amablemente tu respuesta antes del 11 de marzo de 2026.</p>
            
            <!-- Mobile button (hidden on desktop) -->
            <div id="mobile-rsvp-section" style="display: none; margin-top: 2rem;">
                <p data-translate="mobile_form_description" style="font-size: 1rem; color: var(--text-light); margin-bottom: 2rem; line-height: 1.6;">
                    Completa el formulario y luego regresa aqu√≠.
                </p>
                
                <!-- First button: Open Form -->
                <button class="mobile-rsvp-button" onclick="openSimpleForm()" data-translate="open_form_button">
                    Abrir Formulario
                </button>
                
                <!-- Separation between buttons -->
                <div class="button-separator">
                    <span data-translate="button_separator_text">‚Üì Despu√©s de completar el formulario ‚Üì</span>
                </div>
                
                <!-- Second button: I'm Done -->
                <button class="mobile-rsvp-button mobile-done-button" onclick="goToConfirmation()" data-translate="form_done_button">
                    He Terminado
                </button>
            </div>
        </section>
        
        <!-- Custom confirmation that will be shown after form submission -->
        <section id="custom-confirmation" class="form-container" style="display: none;">
            <div class="confirmation-content">
                <h3 data-translate="rsvp_thank_you">¬°Gracias!</h3>
                <p data-translate="rsvp_received">Hemos recibido tu confirmaci√≥n de asistencia. ¬°Esperamos celebrar contigo!</p>
                <p data-translate="rsvp_update">Si necesitas actualizar tu respuesta, por favor cont√°ctanos directamente.</p>
                <a href="index.html" class="button" data-translate="return_home">Volver al Inicio</a>
            </div>
        </section>

        <!-- Desktop Google Form container (shown on desktop) -->
        <section id="google-form-container" class="form-container">
            <div class="google-form-viewport" id="google-form-viewport">
                <div class="google-form-container">
                    <iframe id="google-form" class="embedded-google-form"
                        src="https://docs.google.com/forms/d/e/1FAIpQLSeelG8fN-NsqpAbFkOsk-njF7YsDxEsltkH589aCJOKVrMkYA/viewform?embedded=true" 
                        width="100%" 
                        frameborder="0" 
                        marginheight="0" 
                        marginwidth="0">
                        Cargando...
                    </iframe>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <p data-translate="footer_text">&copy; 2025 Boda de Marianela y Daniel</p>
    </footer>
    
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if this is a success redirect
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                showConfirmationMessage();
                return;
            }
            
            // Determine which interface to show based on screen size
            setupResponsiveRSVP();
            
            // Handle screen size changes
            window.addEventListener('resize', setupResponsiveRSVP);
        });

        function setupResponsiveRSVP() {
            const mobileSection = document.getElementById('mobile-rsvp-section');
            const desktopContainer = document.getElementById('google-form-container');
            
            if (window.matchMedia('(max-width: 480px)').matches) {
                // Mobile: show button in welcome section, hide desktop form
                if (mobileSection) mobileSection.style.display = 'block';
                if (desktopContainer) desktopContainer.style.display = 'none';
            } else {
                // Desktop: hide mobile button, show desktop form
                if (mobileSection) mobileSection.style.display = 'none';
                if (desktopContainer) {
                    desktopContainer.style.display = 'block';
                    setupDesktopIframe();
                }
            }
        }

        function setupDesktopIframe() {
            // Restore the original working desktop iframe configuration
            const formIframe = document.getElementById('google-form');
            const viewport = document.getElementById('google-form-viewport');
            const innerContainer = document.querySelector('.google-form-container');
            
            if (!formIframe || !viewport || !innerContainer) return;
            
            // Original working configuration values
            const HIDE_TOP_DESKTOP = 260;
            const IFRAME_HEIGHT_DESKTOP = 1600;
            const BOTTOM_GAP_DESKTOP = 172;
            
            // Set iframe height
            formIframe.style.height = IFRAME_HEIGHT_DESKTOP + 'px';
            formIframe.style.minHeight = '900px';
            
            // Calculate and set viewport height
            let viewportHeight = IFRAME_HEIGHT_DESKTOP - HIDE_TOP_DESKTOP - BOTTOM_GAP_DESKTOP;
            if (viewportHeight < 400) viewportHeight = 400;
            viewport.style.height = viewportHeight + 'px';
            
            // Apply vertical shift to hide Google Forms header
            innerContainer.style.transform = 'translateY(-' + HIDE_TOP_DESKTOP + 'px)';
            
            // Enhanced form submission detection for desktop
            setupDesktopFormSubmissionDetection(formIframe);
        }

        function setupDesktopFormSubmissionDetection(formIframe) {
            // Method 1: Enhanced iframe load detection
            let loadCount = 0;
            formIframe.addEventListener('load', function() {
                loadCount++;
                console.log('Iframe load event #' + loadCount);
                
                // After the second load (first is initial, second is after submission)
                if (loadCount >= 2) {
                    setTimeout(() => {
                        console.log('Form likely submitted, redirecting to confirmation...');
                        window.location.href = 'rsvp.html?success=true';
                    }, 1500); // Wait 1.5 seconds to ensure form processing
                }
                
                // Fallback: try to read iframe content
                setTimeout(function() {
                    try {
                        const iframeDoc = formIframe.contentDocument || formIframe.contentWindow.document;
                        const bodyText = iframeDoc.body.innerText || iframeDoc.body.textContent;
                        
                        if (bodyText.includes('Tu respuesta') || 
                            bodyText.includes('Your response') ||
                            bodyText.includes('ha sido registrada') ||
                            bodyText.includes('has been recorded')) {
                            console.log('Submission confirmation detected in iframe content');
                            window.location.href = 'rsvp.html?success=true';
                        }
                    } catch(e) {
                        // Expected due to cross-origin restrictions
                        console.log('Cannot access iframe content (normal behavior)');
                    }
                }, 1000);
            });
            
            // Method 2: Enhanced message listener
            window.addEventListener('message', function(e) {
                console.log('Message received from:', e.origin, 'Data:', e.data);
                
                if (e.origin.includes('google.com') || e.origin.includes('docs.google.com')) {
                    if (typeof e.data === 'string') {
                        const data = e.data.toLowerCase();
                        if (data.includes('formresponse') || 
                            data.includes('submitted') || 
                            data.includes('confirmation') ||
                            data.includes('close') ||
                            data.includes('success')) {
                            console.log('Form submission detected via message event');
                            setTimeout(() => {
                                window.location.href = 'rsvp.html?success=true';
                            }, 1000);
                        }
                    }
                }
            });
            
            // Method 3: Periodic iframe URL checking (enhanced)
            let urlCheckCount = 0;
            const checkIframeUrl = setInterval(function() {
                urlCheckCount++;
                try {
                    const currentUrl = formIframe.contentWindow.location.href;
                    console.log('Checking iframe URL:', currentUrl);
                    
                    if (currentUrl.includes('formResponse') || 
                        currentUrl.includes('closedform') ||
                        currentUrl.includes('thanks')) {
                        console.log('Form submission detected via URL change');
                        clearInterval(checkIframeUrl);
                        window.location.href = 'rsvp.html?success=true';
                    }
                } catch(e) {
                    // Expected due to cross-origin restrictions
                }
                
                // Stop checking after 5 minutes
                if (urlCheckCount > 300) {
                    clearInterval(checkIframeUrl);
                }
            }, 1000);
        }

        function openSimpleForm() {
            // Open form in new tab - simple and reliable
            window.open(
                'https://docs.google.com/forms/d/e/1FAIpQLSeelG8fN-NsqpAbFkOsk-njF7YsDxEsltkH589aCJOKVrMkYA/viewform',
                '_blank'
            );
        }

        function goToConfirmation() {
            // Direct redirect to thank you page
            window.location.href = 'rsvp.html?success=true';
        }

        function redirectToConfirmation() {
            localStorage.removeItem('weddingFormSubmissionPending');
            localStorage.removeItem('weddingFormOpenTime');
            console.log('Redirecting to confirmation page...');
            window.location.href = 'rsvp.html?success=true';
        }

        function showConfirmationMessage() {
            // Hide both form interfaces
            const mobileSection = document.getElementById('mobile-rsvp-section');
            const desktopContainer = document.getElementById('google-form-container');
            const confirmationContainer = document.getElementById('custom-confirmation');
            const welcomeSection = document.querySelector('.welcome');
            
            if (mobileSection) mobileSection.style.display = 'none';
            if (desktopContainer) desktopContainer.style.display = 'none';
            if (confirmationContainer) confirmationContainer.style.display = 'block';
            
            // Also hide the welcome section description to avoid duplication
            if (welcomeSection) {
                const welcomeP = welcomeSection.querySelector('p[data-translate="rsvp_description"]');
                if (welcomeP) welcomeP.style.display = 'none';
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>