<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Asistencia - Boda de Marianela y Daniel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíç</text></svg>">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <button id="language-toggle" class="language-toggle" aria-label="Switch to English">EN</button>
        <div class="header-content">
            <h1>Marianela <span class="ampersand">&</span> Daniel</h1>
            <p class="date" data-translate="header_date">11 de abril, 2026</p>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="index.html" data-translate="nav_home">Inicio</a></li>
            <li><a href="details.html" data-translate="nav_details">Detalles</a></li>
            <li><a href="rsvp.html" class="active" data-translate="nav_rsvp">Confirmar Asistencia</a></li>
        </ul>
    </nav>
    
    <main>
        <section class="welcome">
            <h2 data-translate="rsvp_title">Confirma tu Asistencia a Nuestra Boda</h2>
            <p data-translate="rsvp_description">Por favor d√©janos saber si podr√°s acompa√±arnos en nuestro d√≠a especial. Te pedimos amablemente tu respuesta antes del 11 de marzo de 2026.</p>
        </section>
        
        <!-- Custom confirmation that will be shown after form submission -->
        <section id="custom-confirmation" class="form-container" style="display: none;">
            <div class="confirmation-content">
                <h3 data-translate="rsvp_thank_you">¬°Gracias!</h3>
                <p data-translate="rsvp_received">Hemos recibido tu confirmaci√≥n de asistencia. ¬°Esperamos celebrar contigo!</p>
                <p data-translate="rsvp_update">Si necesitas actualizar tu respuesta, por favor cont√°ctanos directamente.</p>
                <a href="index.html" class="button" data-translate="return_home">Volver al Inicio</a>
            </div>
        </section>
        
        <!-- Mobile RSVP Container (shown on mobile) -->
        <section id="mobile-rsvp-container" class="mobile-rsvp-container">
            <h3 data-translate="rsvp_title">Confirma tu Asistencia</h3>
            <p data-translate="mobile_form_description">Para una mejor experiencia en m√≥vil, el formulario se abrir√° en una nueva ventana. Una vez completado, regresar√°s autom√°ticamente aqu√≠.</p>
            <button class="mobile-rsvp-button" onclick="openMobileForm()" data-translate="open_form_button">
                Abrir Formulario
            </button>
        </section>

        <!-- Desktop Google Form container (shown on desktop) -->
        <section id="google-form-container" class="form-container">
            <div class="google-form-viewport" id="google-form-viewport">
                <div class="google-form-container">
                    <iframe id="google-form" class="embedded-google-form"
                        src="https://docs.google.com/forms/d/e/1FAIpQLSeelG8fN-NsqpAbFkOsk-njF7YsDxEsltkH589aCJOKVrMkYA/viewform?embedded=true" 
                        width="100%" 
                        frameborder="0" 
                        marginheight="0" 
                        marginwidth="0">
                        Cargando...
                    </iframe>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <p data-translate="footer_text">&copy; 2025 Boda de Marianela y Daniel</p>
    </footer>
    
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if this is a success redirect
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                showConfirmationMessage();
                return;
            }
            
            // Determine which interface to show based on screen size
            if (window.matchMedia('(max-width: 480px)').matches) {
                setupMobileRSVP();
            } else {
                setupDesktopRSVP();
            }
            
            // Handle screen size changes
            window.addEventListener('resize', function() {
                if (window.matchMedia('(max-width: 480px)').matches) {
                    setupMobileRSVP();
                } else {
                    setupDesktopRSVP();
                }
            });
        });

        function setupMobileRSVP() {
            // Show mobile container, hide desktop form
            const mobileContainer = document.getElementById('mobile-rsvp-container');
            const desktopContainer = document.getElementById('google-form-container');
            
            if (mobileContainer) mobileContainer.style.display = 'block';
            if (desktopContainer) desktopContainer.classList.add('mobile-hidden');
        }

        function setupDesktopRSVP() {
            // Show desktop form, hide mobile container
            const mobileContainer = document.getElementById('mobile-rsvp-container');
            const desktopContainer = document.getElementById('google-form-container');
            
            if (mobileContainer) mobileContainer.style.display = 'none';
            if (desktopContainer) {
                desktopContainer.classList.remove('mobile-hidden');
                desktopContainer.style.display = 'block';
            }
            
            // Set up desktop iframe if needed
            setupDesktopIframe();
        }

        function setupDesktopIframe() {
            // Basic iframe setup for desktop - simplified from the original
            const formIframe = document.getElementById('google-form');
            if (!formIframe) return;
            
            // Set reasonable height for desktop
            formIframe.style.height = '1200px';
            formIframe.style.minHeight = '800px';
            
            // Listen for form submission on desktop (basic version)
            formIframe.addEventListener('load', function() {
                // Give it a moment for the form to potentially redirect
                setTimeout(function() {
                    // Check if we should show confirmation (basic detection)
                    try {
                        const iframeDoc = formIframe.contentDocument || formIframe.contentWindow.document;
                        if (iframeDoc.body.innerHTML.includes('Tu respuesta') || 
                            iframeDoc.body.innerHTML.includes('Your response')) {
                            window.location.href = 'rsvp.html?success=true';
                        }
                    } catch(e) {
                        // Cross-origin restrictions - this is normal
                        console.log('Cannot access iframe content (normal security restriction)');
                    }
                }, 2000);
            });
        }

        function openMobileForm() {
            // Store that we're expecting a form submission
            localStorage.setItem('weddingFormSubmissionPending', 'true');
            localStorage.setItem('weddingFormOpenTime', Date.now().toString());
            
            // Open form in new window
            const formWindow = window.open(
                'https://docs.google.com/forms/d/e/1FAIpQLSeelG8fN-NsqpAbFkOsk-njF7YsDxEsltkH589aCJOKVrMkYA/viewform',
                'weddingRSVPForm',
                'width=800,height=900,scrollbars=yes,resizable=yes'
            );
            
            if (!formWindow) {
                alert('Por favor permite ventanas emergentes para abrir el formulario de confirmaci√≥n.');
                return;
            }
            
            // Monitor the form window
            monitorFormWindow(formWindow);
        }

        function monitorFormWindow(formWindow) {
            const checkInterval = setInterval(() => {
                try {
                    if (formWindow.closed) {
                        clearInterval(checkInterval);
                        handleFormWindowClosed();
                    }
                } catch (e) {
                    clearInterval(checkInterval);
                }
            }, 1000);
            
            // Stop checking after 10 minutes
            setTimeout(() => {
                clearInterval(checkInterval);
            }, 600000);
        }

        function handleFormWindowClosed() {
            const wasFormPending = localStorage.getItem('weddingFormSubmissionPending');
            const openTime = localStorage.getItem('weddingFormOpenTime');
            
            if (wasFormPending === 'true') {
                const timePassed = Date.now() - parseInt(openTime || '0');
                
                if (timePassed > 30000) { // 30 seconds minimum - likely submitted
                    localStorage.removeItem('weddingFormSubmissionPending');
                    localStorage.removeItem('weddingFormOpenTime');
                    window.location.href = 'rsvp.html?success=true';
                } else {
                    // Closed too quickly - probably cancelled
                    localStorage.removeItem('weddingFormSubmissionPending');
                    localStorage.removeItem('weddingFormOpenTime');
                    // Don't do anything - let user try again
                }
            }
        }

        function showConfirmationMessage() {
            // Hide both form containers
            const mobileContainer = document.getElementById('mobile-rsvp-container');
            const desktopContainer = document.getElementById('google-form-container');
            const confirmationContainer = document.getElementById('custom-confirmation');
            
            if (mobileContainer) mobileContainer.style.display = 'none';
            if (desktopContainer) desktopContainer.style.display = 'none';
            if (confirmationContainer) confirmationContainer.style.display = 'block';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>